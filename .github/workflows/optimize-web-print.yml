name: Generate Optimized Figures and Images (Web & Print)

on:
  push:
    paths:
      - 'source-svg/**.svg'
      - 'svgo.config.js'
      - 'source-people/**'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      # --- SETUP TOOLS ---
      - name: Install Node & SVGO
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install -g svgo

      - name: Install Inkscape
        run: |
          sudo apt-get update
          sudo apt-get install -y inkscape

      # --- PREPARE FOLDERS ---
      - name: Create Web and Print Directories
        run: |
          mkdir -p dist/web
          mkdir -p dist/print

      # --- GENERATE WEB ASSETS (Optimized SVG) ---
      - name: Generate Web Assets
        # Optimizes SVGs for small size and RGB color
        run: svgo -f source-svg -o dist/web

      # --- GENERATE PRINT ASSETS (PDF) ---
      - name: Generate Print Assets
        # Converts SVGs to high-res PDF for manuscripts
        run: |
          for file in source-svg/*.svg; do
            filename=$(basename "$file" .svg)
            echo "Converting $filename to PDF..."
            inkscape "$file" --export-filename="dist/print/$filename.pdf"
          done
      
      # --- PROCESS PEOPLE (Square JPG -> Standardized WebP) ---
      - name: Convert Headshots to WebP
        run: |
          mkdir -p dist/web/people
          shopt -s nullglob
          for file in source-people/*.{jpg,jpeg,png,JPG,JPEG,PNG}; do
            filename=$(basename "$file")
            name="${filename%.*}"
            
            echo "Processing $filename..."
            
            # -q 80: Quality 80%
            # -resize 600 600: Force image to exactly 600x600px
            # This ensures uniformity even if they uploaded a huge 4000px square
            cwebp -q 80 "$file" -resize 600 600 -o "dist/web/people/$name.webp"
          done

      # --- DEPLOY ---
      - name: Deploy to 'dist' branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: dist
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "ðŸš€ Update Web and Print assets"